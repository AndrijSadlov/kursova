<!DOCTYPE html>
<html lang="uk">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Система обліку військовослужбовців</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        military: {
                            50: '#f0f9ff',
                            500: '#0ea5e9',
                            600: '#0284c7',
                            700: '#0369a1',
                            800: '#075985',
                            900: '#0c4a6e'
                        }
                    }
                }
            }
        }
    </script>
    <style>
        /* Фікс для фону на мобільних */
        .bg-fixed-cover {
            background-attachment: fixed;
            background-size: cover;
            background-position: center;
        }
    </style>
</head>
<body class="bg-gray-50 flex flex-col min-h-screen">

<div id="unit-modal" class="fixed inset-0 bg-gray-900 bg-opacity-90 z-50 flex items-center justify-center hidden p-4">
    <div class="bg-white p-6 md:p-8 rounded-lg shadow-xl max-w-md w-full">
        <h2 class="text-2xl font-bold mb-4 text-gray-800">Оберіть підрозділ</h2>
        <p class="mb-4 text-gray-600">Для продовження роботи оберіть підрозділ зі списку:</p>
        <select id="unit-select" class="w-full p-3 border rounded mb-6 text-lg bg-white">
            <option value="">Завантаження...</option>
        </select>
        <div class="flex justify-between items-center">
             <button onclick="handleLogout()" class="text-red-500 hover:underline text-sm">Вийти</button>
             <button onclick="confirmUnitSelection()" class="bg-military-600 text-white px-6 py-2 rounded hover:bg-military-700 font-bold transition-colors">Обрати</button>
        </div>
    </div>
</div>

<div id="auth-container" class="relative min-h-screen flex items-center justify-center p-4 hidden">
    <div class="absolute inset-0 bg-fixed-cover z-0" style="background-image: url('https://www.istpravda.com.ua/images/doc/b/8/b8435c6-dscn2023.jpg'); filter: brightness(0.4);"></div>
    
    <div class="relative z-10 w-full max-w-md">
        <form id="login-form" class="bg-gray-800/80 backdrop-blur-lg shadow-xl rounded-lg p-8 space-y-6 border border-gray-200/20">
            <div class="text-center">
                <i class="fas fa-shield-alt text-4xl text-military-500 mb-2"></i>
                <h2 class="text-2xl font-bold text-white">Вхід в систему</h2>
            </div>
            <div>
                <label for="login-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                <input id="login-email" type="email" required class="w-full px-3 py-2 bg-gray-700/50 text-white border border-gray-500 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
            </div>
            <div>
                <label for="login-password" class="block text-sm font-medium text-gray-300 mb-2">Пароль</label>
                <input id="login-password" type="password" required class="w-full px-3 py-2 bg-gray-700/50 text-white border border-gray-500 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-military-600 text-white rounded-md hover:bg-military-700 transition-colors font-semibold">
                Увійти
            </button>
            <p class="text-center text-sm text-gray-400">
                Немає акаунту? 
                <button type="button" onclick="toggleAuthForm()" class="font-medium text-military-500 hover:text-military-400">Зареєструватися</button>
            </p>
        </form>

        <form id="register-form" class="bg-gray-800/80 backdrop-blur-lg shadow-xl rounded-lg p-8 space-y-6 border border-gray-200/20 hidden">
             <div class="text-center">
                <i class="fas fa-user-plus text-4xl text-military-500 mb-2"></i>
                <h2 class="text-2xl font-bold text-white">Створення акаунту</h2>
            </div>
            <div>
                <label for="register-email" class="block text-sm font-medium text-gray-300 mb-2">Email</label>
                <input id="register-email" type="email" required class="w-full px-3 py-2 bg-gray-700/50 text-white border border-gray-500 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
            </div>
            <div>
                <label for="register-password" class="block text-sm font-medium text-gray-300 mb-2">Пароль (мін. 6 символів)</label>
                <input id="register-password" type="password" required class="w-full px-3 py-2 bg-gray-700/50 text-white border border-gray-500 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
            </div>
            <button type="submit" class="w-full px-4 py-2 bg-military-600 text-white rounded-md hover:bg-military-700 transition-colors font-semibold">
                Зареєструватися
            </button>
            <p class="text-center text-sm text-gray-400">
                Вже є акаунт? 
                <button type="button" onclick="toggleAuthForm()" class="font-medium text-military-500 hover:text-military-400">Увійти</button>
            </p>
        </form>
    </div>
</div>

<div id="app" class="hidden flex flex-col min-h-screen">
    
    <nav class="bg-military-800 text-white shadow-lg sticky top-0 z-40">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-16">
                <div class="flex items-center truncate">
                    <i class="fas fa-shield-alt text-2xl mr-3 shrink-0"></i>
                    <div class="truncate">
                        <h1 class="text-lg md:text-xl font-bold truncate">Облік в/с</h1>
                        <span id="header-unit-name" class="text-xs text-gray-300 font-normal block truncate"></span>
                    </div>
                </div>

                <div class="hidden md:flex items-center space-x-4">
                    <button onclick="showPage('dashboard')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-military-700 transition-colors">
                        <i class="fas fa-chart-dashboard mr-1"></i>Дашборд
                    </button>
                    <button onclick="showPage('personnel')" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-military-700 transition-colors">
                        <i class="fas fa-users mr-1"></i>Персонал
                    </button>
                    <button onclick="showPage('users')" id="nav-users-btn" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-military-700 transition-colors hidden">
                        <i class="fas fa-user-cog mr-1"></i>Користувачі
                    </button>
                    <button onclick="prepareAndShowAddPage()" id="nav-add-btn" class="nav-btn px-3 py-2 rounded-md text-sm font-medium hover:bg-military-700 transition-colors">
                        <i class="fas fa-user-plus mr-1"></i>Додати
                    </button>
                    <button onclick="changeUnit()" class="px-3 py-2 rounded-md text-sm font-medium bg-military-700 hover:bg-military-600 transition-colors border border-military-600">
                        <i class="fas fa-exchange-alt mr-1"></i>Підрозділ
                    </button>
                    <button onclick="handleLogout()" class="px-3 py-2 rounded-md text-sm font-medium hover:bg-red-600 transition-colors">
                        <i class="fas fa-sign-out-alt mr-1"></i>
                    </button>
                </div>

                <div class="flex items-center md:hidden">
                    <button onclick="toggleMobileMenu()" class="p-2 rounded-md text-gray-200 hover:text-white hover:bg-military-700 focus:outline-none">
                        <i class="fas fa-bars text-2xl"></i>
                    </button>
                </div>
            </div>
        </div>

        <div id="mobile-menu" class="hidden md:hidden bg-military-900 border-t border-military-700">
            <div class="px-2 pt-2 pb-3 space-y-1">
                <button onclick="showPage('dashboard'); toggleMobileMenu()" class="nav-btn block w-full text-left px-3 py-2 rounded-md text-base font-medium hover:bg-military-700">
                    <i class="fas fa-chart-dashboard mr-2 w-6 text-center"></i>Дашборд
                </button>
                <button onclick="showPage('personnel'); toggleMobileMenu()" class="nav-btn block w-full text-left px-3 py-2 rounded-md text-base font-medium hover:bg-military-700">
                    <i class="fas fa-users mr-2 w-6 text-center"></i>Персонал
                </button>
                <button onclick="showPage('users'); toggleMobileMenu()" id="mobile-users-btn" class="nav-btn block w-full text-left px-3 py-2 rounded-md text-base font-medium hover:bg-military-700 hidden">
                    <i class="fas fa-user-cog mr-2 w-6 text-center"></i>Користувачі
                </button>
                <button onclick="prepareAndShowAddPage(); toggleMobileMenu()" id="mobile-add-btn" class="nav-btn block w-full text-left px-3 py-2 rounded-md text-base font-medium hover:bg-military-700">
                    <i class="fas fa-user-plus mr-2 w-6 text-center"></i>Додати запис
                </button>
                <button onclick="changeUnit(); toggleMobileMenu()" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium hover:bg-military-700 text-yellow-400">
                    <i class="fas fa-exchange-alt mr-2 w-6 text-center"></i>Змінити підрозділ
                </button>
                <button onclick="handleLogout()" class="block w-full text-left px-3 py-2 rounded-md text-base font-medium hover:bg-red-700 text-red-400">
                    <i class="fas fa-sign-out-alt mr-2 w-6 text-center"></i>Вийти
                </button>
            </div>
        </div>
    </nav>

    <div class="flex-grow w-full max-w-7xl mx-auto py-4 sm:py-6 sm:px-6 lg:px-8">
        
        <div id="dashboard-page" class="page px-2 sm:px-0">
            <h2 class="text-2xl font-bold text-gray-900 mb-4 px-2">Дашборд <span id="dashboard-unit-label" class="text-lg font-normal text-gray-500 ml-2"></span></h2>
            
            <div class="grid grid-cols-2 md:grid-cols-4 gap-3 mb-6 px-2">
                <div class="bg-white p-4 shadow rounded-lg flex flex-col items-center justify-center text-center">
                    <div class="bg-blue-100 rounded-full p-2 mb-2"><i class="fas fa-users text-blue-600 text-xl"></i></div>
                    <dt class="text-xs font-medium text-gray-500">Всього</dt>
                    <dd class="text-2xl font-bold text-gray-900" id="total-count">0</dd>
                </div>
                <div class="bg-white p-4 shadow rounded-lg flex flex-col items-center justify-center text-center">
                    <div class="bg-green-100 rounded-full p-2 mb-2"><i class="fas fa-user-check text-green-600 text-xl"></i></div>
                    <dt class="text-xs font-medium text-gray-500">Активних</dt>
                    <dd class="text-2xl font-bold text-gray-900" id="active-count">0</dd>
                </div>
                <div class="bg-white p-4 shadow rounded-lg flex flex-col items-center justify-center text-center">
                    <div class="bg-red-100 rounded-full p-2 mb-2"><i class="fas fa-user-times text-red-600 text-xl"></i></div>
                    <dt class="text-xs font-medium text-gray-500">Неактивних</dt>
                    <dd class="text-2xl font-bold text-gray-900" id="inactive-count">0</dd>
                </div>
                <div class="bg-white p-4 shadow rounded-lg flex flex-col items-center justify-center text-center">
                    <div class="bg-yellow-100 rounded-full p-2 mb-2"><i class="fas fa-user-clock text-yellow-600 text-xl"></i></div>
                    <dt class="text-xs font-medium text-gray-500">У відпустці</dt>
                    <dd class="text-2xl font-bold text-gray-900" id="leave-count">0</dd>
                </div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 px-2">
                <div class="lg:col-span-1 space-y-6">
                    <div class="bg-white shadow rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Статуси персоналу</h3>
                        <div class="h-48 flex items-center justify-center">
                            <canvas id="status-chart"></canvas>
                        </div>
                    </div>
                    <div class="bg-white shadow rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Групи крові</h3>
                        <div id="blood-type-stats" class="space-y-2"></div>
                    </div>
                </div>

                <div class="lg:col-span-2 space-y-6">
                    <div class="bg-white shadow rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Топ-5 звань за кількістю</h3>
                        <div id="rank-stats" class="space-y-2"></div>
                    </div>
                    <div class="bg-white shadow rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Топ-5 підрозділів за кількістю</h3>
                        <div id="unit-stats" class="space-y-2"></div>
                    </div>
                    <div class="bg-white shadow rounded-lg p-4">
                        <h3 class="text-lg font-medium text-gray-900 mb-2">Останні додані службовці</h3>
                        <ul id="recent-additions-list" class="divide-y divide-gray-200"></ul>
                    </div>
                </div>
            </div>
        </div>

        <div id="personnel-page" class="page hidden px-2 sm:px-0">
            <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-4 gap-2 px-2">
                <h2 class="text-2xl font-bold text-gray-900">Список персоналу</h2>
                <button onclick="prepareAndShowAddPage()" id="list-add-btn" class="w-full sm:w-auto bg-military-600 hover:bg-military-700 text-white px-4 py-2 rounded-md transition-colors">
                    <i class="fas fa-plus mr-2"></i>Додати нового
                </button>
            </div>

            <div class="bg-white shadow rounded-lg p-4 mb-4 mx-2">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Пошук</label>
                        <input type="text" id="search-input" placeholder="Прізвище, ім'я або ID" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">Статус</label>
                        <select id="status-filter" class="w-full px-3 py-2 border rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                            <option value="">Всі статуси</option>
                            <option value="active">Активний</option>
                            <option value="inactive">Неактивний</option>
                            <option value="leave">У відпустці</option>
                        </select>
                    </div>
                    <div class="flex items-end">
                        <button onclick="searchPersonnel()" class="w-full bg-military-600 hover:bg-military-700 text-white px-4 py-2 rounded-md transition-colors">
                            <i class="fas fa-search mr-2"></i>Пошук
                        </button>
                    </div>
                </div>
            </div>

            <div class="bg-white shadow rounded-lg overflow-x-auto mx-2">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">ПІБ / ID</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden sm:table-cell">Звання</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase hidden md:table-cell">Підрозділ</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Статус</th>
                            <th class="px-4 py-3 text-right text-xs font-medium text-gray-500 uppercase">Дії</th>
                        </tr>
                    </thead>
                    <tbody id="personnel-table-body" class="bg-white divide-y divide-gray-200">
                        </tbody>
                </table>
            </div>
            <div id="pagination" class="flex justify-center mt-4 px-2"></div>
        </div>

        <div id="users-page" class="page hidden px-2 sm:px-0">
            <div class="px-2">
                <h2 class="text-2xl font-bold text-gray-900 mb-4">Керування користувачами</h2>
                <p class="mb-4 text-sm text-gray-600">Тут ви можете змінювати права доступу інших користувачів.</p>
                
                <div class="bg-white shadow rounded-lg overflow-hidden">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Роль</th>
                                <th class="px-6 py-3 text-right text-xs font-medium text-gray-500 uppercase">Дії</th>
                            </tr>
                        </thead>
                        <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                            </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div id="add-page" class="page hidden px-2 sm:px-0">
            <div class="bg-white shadow rounded-lg p-4 md:p-6 mx-2">
                <div class="flex justify-between items-center mb-4">
                    <h2 id="form-title" class="text-xl font-bold text-gray-900">Додати військовослужбовця</h2>
                    <button onclick="showPage('personnel')" class="text-gray-600 hover:text-gray-800">
                        <i class="fas fa-times text-2xl"></i>
                    </button>
                </div>

                <form id="personnel-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        
                        <div class="col-span-1 md:col-span-2">
                            <h3 class="text-lg font-medium text-gray-900 mb-2 border-b pb-2">Основна інформація</h3>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Військовий ID *</label>
                            <input type="text" name="militaryId" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Прізвище *</label>
                            <input type="text" name="lastName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Ім'я *</label>
                            <input type="text" name="firstName" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">По батькові</label>
                            <input type="text" name="middleName" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Дата народження *</label>
                            <input type="date" name="birthDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Звання *</label>
                            <select name="rank" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                                <option value="">Оберіть звання</option>
                                <option value="Солдат">Солдат</option>
                                <option value="Старший солдат">Старший солдат</option>
                                <option value="Молодший сержант">Молодший сержант</option>
                                <option value="Сержант">Сержант</option>
                                <option value="Старший сержант">Старший сержант</option>
                                <option value="Старшина">Старшина</option>
                                <option value="Прапорщик">Прапорщик</option>
                                <option value="Старший прапорщик">Старший прапорщик</option>
                                <option value="Молодший лейтенант">Молодший лейтенант</option>
                                <option value="Лейтенант">Лейтенант</option>
                                <option value="Старший лейтенант">Старший лейтенант</option>
                                <option value="Капітан">Капітан</option>
                                <option value="Майор">Майор</option>
                                <option value="Підполковник">Підполковник</option>
                                <option value="Полковник">Полковник</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Посада *</label>
                            <input type="text" name="position" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Підрозділ *</label>
                            <input type="text" name="unit" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Дата початку служби *</label>
                            <input type="date" name="serviceStartDate" required class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Статус</label>
                            <select name="status" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                                <option value="active">Активний</option>
                                <option value="inactive">Неактивний</option>
                                <option value="leave">У відпустці</option>
                            </select>
                        </div>

                        <div class="col-span-1 md:col-span-2 mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-2 border-b pb-2">Контактна інформація</h3>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Телефон</label>
                            <input type="tel" name="phone" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Email</label>
                            <input type="email" name="email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                        </div>

                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Адреса</label>
                            <textarea name="address" rows="3" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500"></textarea>
                        </div>

                        <div class="col-span-1 md:col-span-2 mt-4">
                            <h3 class="text-lg font-medium text-gray-900 mb-2 border-b pb-2">Медична інформація</h3>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Група крові</label>
                            <select name="medicalInfo.bloodType" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500">
                                <option value="">Не вказано</option>
                                <option value="O(I) Rh+">O(I) Rh+</option>
                                <option value="O(I) Rh-">O(I) Rh-</option>
                                <option value="A(II) Rh+">A(II) Rh+</option>
                                <option value="A(II) Rh-">A(II) Rh-</option>
                                <option value="B(III) Rh+">B(III) Rh+</option>
                                <option value="B(III) Rh-">B(III) Rh-</option>
                                <option value="AB(IV) Rh+">AB(IV) Rh+</option>
                                <option value="AB(IV) Rh-">AB(IV) Rh-</option>
                            </select>
                        </div>

                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Алергії</label>
                            <input type="text" name="medicalInfo.allergies" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500" placeholder="Наприклад, на пеніцилін">
                        </div>

                        <div class="col-span-1 md:col-span-2">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Медикаменти, що постійно вживаються</label>
                            <textarea name="medicalInfo.medications" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-military-500"></textarea>
                        </div>

                    </div>

                    <div class="flex justify-end space-x-4 mt-8 pt-4 border-t">
                        <button type="button" onclick="showPage('personnel')" class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 transition-colors">
                            Скасувати
                        </button>
                        <button type="submit" class="px-4 py-2 bg-military-600 text-white rounded-md hover:bg-military-700 transition-colors">
                            <i class="fas fa-save mr-2"></i>Зберегти
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
    let currentPage = 'dashboard';
    let currentPersonnel = [];
    let editingPersonnel = null;
    let currentPagination = { current: 1, pages: 1, total: 0 };
    let userRole = localStorage.getItem('role') || 'user';
    let currentUnit = localStorage.getItem('currentUnit') || '';
    const API_BASE = '/api';

    // --- MOBILE MENU TOGGLE ---
    function toggleMobileMenu() {
        const menu = document.getElementById('mobile-menu');
        menu.classList.toggle('hidden');
    }

    // --- AUTH ---
    function toggleAuthForm() {
        document.getElementById('login-form').classList.toggle('hidden');
        document.getElementById('register-form').classList.toggle('hidden');
    }

    async function handleLogin(event) {
        event.preventDefault();
        const email = document.getElementById('login-email').value;
        const password = document.getElementById('login-password').value;
        try {
            const response = await fetch(`${API_BASE}/auth/login`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const result = await response.json();
            if (result.success) {
                localStorage.setItem('token', result.token);
                localStorage.setItem('role', result.role);
                userRole = result.role;
                document.getElementById('auth-container').classList.add('hidden');
                document.getElementById('app').classList.remove('hidden');
                loadUnitsAndShowModal();
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('Помилка входу');
        }
    }

    async function handleRegister(event) {
        event.preventDefault();
        const email = document.getElementById('register-email').value;
        const password = document.getElementById('register-password').value;
        try {
            const response = await fetch(`${API_BASE}/auth/register`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ email, password })
            });
            const result = await response.json();
            if (result.success) {
                alert('Успішно! Увійдіть.');
                toggleAuthForm();
            } else {
                alert(result.message);
            }
        } catch (error) {
            alert('Помилка реєстрації');
        }
    }

    function handleLogout() {
        localStorage.clear();
        location.reload();
    }

    // --- DATA LOADING ---
    async function fetchProtected(url, options = {}) {
        const token = localStorage.getItem('token');
        const headers = { 'Content-Type': 'application/json', ...options.headers };
        if (token) headers['Authorization'] = `Bearer ${token}`;
        const response = await fetch(url, { ...options, headers });
        if (response.status === 401) {
            handleLogout();
            throw new Error('Unauthorized');
        }
        return response;
    }

    document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('login-form').addEventListener('submit', handleLogin);
        document.getElementById('register-form').addEventListener('submit', handleRegister);
        if (localStorage.getItem('token')) {
            document.getElementById('app').classList.remove('hidden');
            loadUnitsAndShowModal();
        } else {
            document.getElementById('auth-container').classList.remove('hidden');
        }
    });

    // --- UNIT SELECTION ---
    async function loadUnitsAndShowModal() {
        if (currentUnit) { updateAppForUnit(); return; }
        try {
            const response = await fetchProtected(`${API_BASE}/personnel/units`);
            const result = await response.json();
            const select = document.getElementById('unit-select');
            select.innerHTML = '<option value="">-- Оберіть --</option>';
            if(userRole === 'admin') select.innerHTML += '<option value="ALL">Всі (Адмін)</option>';
            result.data.forEach(u => select.innerHTML += `<option value="${u}">${u}</option>`);
            document.getElementById('unit-modal').classList.remove('hidden');
        } catch (e) { console.error(e); }
    }

    function confirmUnitSelection() {
        const val = document.getElementById('unit-select').value;
        if (!val) return alert('Оберіть підрозділ');
        currentUnit = val === 'ALL' ? '' : val;
        localStorage.setItem('currentUnit', currentUnit);
        document.getElementById('unit-modal').classList.add('hidden');
        updateAppForUnit();
    }

    function changeUnit() {
        localStorage.removeItem('currentUnit');
        currentUnit = '';
        loadUnitsAndShowModal();
    }

    function updateAppForUnit() {
        const name = currentUnit || 'Всі підрозділи';
        document.getElementById('header-unit-name').textContent = name;
        document.getElementById('dashboard-unit-label').textContent = name;
        showPage('dashboard');
        applyRolePermissions();
    }

    // --- PERMISSIONS ---
    function applyRolePermissions() {
        const isUser = userRole !== 'admin';
        const elementsToHide = ['nav-add-btn', 'mobile-add-btn', 'list-add-btn', 'nav-users-btn', 'mobile-users-btn'];
        elementsToHide.forEach(id => {
            const el = document.getElementById(id);
            if(el) el.style.display = isUser ? 'none' : 'block';
        });
    }

    // --- USERS MANAGEMENT ---
    async function loadUsers() {
        if (userRole !== 'admin') return;
        try {
            const response = await fetchProtected(`${API_BASE}/users`);
            const result = await response.json();
            const tbody = document.getElementById('users-table-body');
            tbody.innerHTML = '';
            
            result.data.forEach(user => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-900">${user.email}</td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm">
                        <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full ${user.role === 'admin' ? 'bg-purple-100 text-purple-800' : 'bg-gray-100 text-gray-800'}">
                            ${user.role}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium">
                        <button onclick="changeUserRole('${user._id}', '${user.role}')" class="text-military-600 hover:text-military-900">
                            ${user.role === 'admin' ? 'Зробити юзером' : 'Зробити адміном'}
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        } catch (error) { console.error(error); }
    }

    async function changeUserRole(id, currentRole) {
        if(!confirm('Змінити роль користувача?')) return;
        const newRole = currentRole === 'admin' ? 'user' : 'admin';
        try {
            const response = await fetchProtected(`${API_BASE}/users/${id}/role`, {
                method: 'PUT',
                body: JSON.stringify({ role: newRole })
            });
            const result = await response.json();
            if (result.success) { alert('Роль змінено'); loadUsers(); } 
            else { alert(result.message); }
        } catch (error) { alert('Помилка'); }
    }

    // --- NAVIGATION ---
    function showPage(page) {
        document.querySelectorAll('.page').forEach(p => p.classList.add('hidden'));
        document.getElementById(page + '-page').classList.remove('hidden');
        currentPage = page;
        
        document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-military-700'));
        
        // Підсвітка активної кнопки
        let activeSelector = '';
        if (page === 'dashboard') activeSelector = `[onclick="showPage('dashboard')"]`;
        else if (page === 'personnel') activeSelector = `[onclick="showPage('personnel')"]`;
        else if (page === 'users') activeSelector = `[onclick="showPage('users')"]`;
        else if (page === 'add') activeSelector = `[onclick="prepareAndShowAddPage()"]`;

        if(activeSelector) {
            const btns = document.querySelectorAll(activeSelector);
            btns.forEach(btn => btn.classList.add('bg-military-700'));
        }

        if (page === 'dashboard') loadStatistics();
        if (page === 'personnel') loadPersonnel();
        if (page === 'users') loadUsers();
    }

    // --- PERSONNEL CRUD ---
    async function loadPersonnel(page = 1) {
        const search = document.getElementById('search-input').value;
        const status = document.getElementById('status-filter').value;
        try {
            const response = await fetchProtected(`${API_BASE}/personnel?page=${page}&unit=${currentUnit}&search=${search}&status=${status}`);
            const result = await response.json();
            currentPersonnel = result.data;
            currentPagination = result.pagination;
            renderPersonnelTable();
            renderPagination();
            applyRolePermissions();
        } catch (e) { console.error(e); }
    }

    function renderPersonnelTable() {
        const tbody = document.getElementById('personnel-table-body');
        tbody.innerHTML = '';
        currentPersonnel.forEach(p => {
            const tr = document.createElement('tr');
            const statusClass = {
                'active': 'text-green-600 bg-green-50 rounded-full px-2 py-1',
                'inactive': 'text-red-600 bg-red-50 rounded-full px-2 py-1',
                'leave': 'text-yellow-600 bg-yellow-50 rounded-full px-2 py-1'
            };
            const statusText = { 'active': 'Активний', 'inactive': 'Неактивний', 'leave': 'У відпустці' };
            
            const delBtn = userRole === 'admin' ? `<button onclick="deletePersonnel('${p._id}')" class="ml-3 text-red-600 hover:text-red-800"><i class="fas fa-trash"></i></button>` : '';
            
            tr.innerHTML = `
                <td class="px-4 py-3">
                    <div class="text-sm font-bold text-gray-900">${p.lastName} ${p.firstName}</div>
                    <div class="text-xs text-gray-500">${p.militaryId}</div>
                </td>
                <td class="px-4 py-3 hidden sm:table-cell text-sm text-gray-700">${p.rank}</td>
                <td class="px-4 py-3 hidden md:table-cell text-sm text-gray-700">${p.unit}</td>
                <td class="px-4 py-3">
                    <span class="text-xs font-bold ${statusClass[p.status]}">${statusText[p.status]}</span>
                </td>
                <td class="px-4 py-3 text-right text-sm font-medium">
                    <button onclick="editPersonnel('${p._id}')" class="text-blue-600 hover:text-blue-800"><i class="fas fa-edit"></i></button>
                    ${delBtn}
                </td>
            `;
            tbody.appendChild(tr);
        });
    }

    function renderPagination() {
        const container = document.getElementById('pagination');
        container.innerHTML = '';
        if (currentPagination.pages <= 1) return;
        
        const div = document.createElement('div');
        div.className = 'flex space-x-2';
        
        for (let i = 1; i <= currentPagination.pages; i++) {
            const btn = document.createElement('button');
            const isActive = i === currentPagination.current;
            btn.className = `px-3 py-1 border rounded ${isActive ? 'bg-military-600 text-white' : 'bg-white text-gray-700'}`;
            btn.textContent = i;
            btn.onclick = () => loadPersonnel(i);
            div.appendChild(btn);
        }
        container.appendChild(div);
    }

    function searchPersonnel() {
        loadPersonnel(1);
    }

    function prepareAndShowAddPage() {
        document.getElementById('personnel-form').reset();
        editingPersonnel = null;
        document.getElementById('form-title').textContent = 'Додати військовослужбовця';
        
        const inputs = document.querySelectorAll('#personnel-form input, #personnel-form select, #personnel-form textarea');
        inputs.forEach(i => { 
            i.disabled = false; 
            i.classList.remove('bg-gray-100', 'cursor-not-allowed'); 
        });
        
        showPage('add');
    }

    async function editPersonnel(id) {
        const p = currentPersonnel.find(x => x._id === id);
        if(!p) return;
        editingPersonnel = p;
        document.getElementById('form-title').textContent = 'Редагувати військовослужбовця';
        
        const form = document.getElementById('personnel-form');
        // Reset form first
        form.reset();

        // Fill simple fields
        const simpleFields = ['militaryId', 'lastName', 'firstName', 'middleName', 'position', 'unit', 'rank', 'phone', 'email', 'address', 'status'];
        simpleFields.forEach(field => {
            if(form[field]) form[field].value = p[field] || '';
        });

        // Fill dates
        if(p.birthDate) form['birthDate'].value = p.birthDate.split('T')[0];
        if(p.serviceStartDate) form['serviceStartDate'].value = p.serviceStartDate.split('T')[0];

        // Fill nested medical info
        if(p.medicalInfo) {
            if(form['medicalInfo.bloodType']) form['medicalInfo.bloodType'].value = p.medicalInfo.bloodType || '';
            if(form['medicalInfo.allergies']) form['medicalInfo.allergies'].value = p.medicalInfo.allergies || '';
            if(form['medicalInfo.medications']) form['medicalInfo.medications'].value = p.medicalInfo.medications || '';
        }

        // Lock fields for non-admins
        const inputs = form.querySelectorAll('input, select, textarea');
        inputs.forEach(input => {
            if (userRole !== 'admin' && input.name !== 'status') {
                input.disabled = true;
                input.classList.add('bg-gray-100', 'cursor-not-allowed');
            } else {
                input.disabled = false;
                input.classList.remove('bg-gray-100', 'cursor-not-allowed');
            }
        });

        showPage('add');
    }

    document.getElementById('personnel-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const formData = new FormData(e.target);
        const data = { medicalInfo: {} };
        
        formData.forEach((value, key) => {
            if(key.startsWith('medicalInfo.')) {
                data.medicalInfo[key.split('.')[1]] = value;
            } else {
                data[key] = value;
            }
        });

        try {
            const url = editingPersonnel ? `${API_BASE}/personnel/${editingPersonnel._id}` : `${API_BASE}/personnel`;
            const method = editingPersonnel ? 'PUT' : 'POST';
            const res = await fetchProtected(url, { method, body: JSON.stringify(data) });
            if(res.ok) {
                alert(editingPersonnel ? 'Дані оновлено' : 'Успішно додано');
                showPage('personnel');
                loadPersonnel();
                loadStatistics();
            } else {
                const err = await res.json();
                alert(err.message);
            }
        } catch(e) { alert('Помилка збереження'); }
    });

    async function deletePersonnel(id) {
        if(!confirm('Видалити цей запис?')) return;
        await fetchProtected(`${API_BASE}/personnel/${id}`, { method: 'DELETE' });
        loadPersonnel();
        loadStatistics();
    }

    // --- RESTORED VISUALIZATIONS ---

    let statusChart = null;
    function renderStatusChart(stats) {
        const ctx = document.getElementById('status-chart');
        if(statusChart) statusChart.destroy();
        
        statusChart = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: ['Активні', 'Неактивні', 'У відпустці'],
                datasets: [{
                    data: [stats.active, stats.inactive, stats.onLeave],
                    backgroundColor: [
                        'rgba(34, 197, 94, 0.8)', 
                        'rgba(239, 68, 68, 0.8)', 
                        'rgba(234, 179, 8, 0.8)'
                    ],
                    borderColor: [
                        'rgba(34, 197, 94, 1)',
                        'rgba(239, 68, 68, 1)',
                        'rgba(234, 179, 8, 1)'
                    ],
                    borderWidth: 1
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { position: 'bottom' }
                },
                cutout: '70%'
            }
        });
    }

    function renderBloodTypeStats(bloodStats) {
        const container = document.getElementById('blood-type-stats');
        container.innerHTML = '';
        const total = bloodStats.reduce((sum, stat) => sum + stat.count, 0);
        if (total === 0) {
             container.innerHTML = '<p class="text-gray-500 text-sm">Немає даних.</p>';
             return;
        }
        bloodStats.forEach(stat => {
            const percentage = ((stat.count / total) * 100).toFixed(1);
            const div = document.createElement('div');
            div.innerHTML = `
                <div class="flex justify-between items-center mb-1 text-sm">
                    <span class="font-medium text-gray-700">${stat._id}</span>
                    <span class="text-gray-500">${stat.count} (${percentage}%)</span>
                </div>
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-red-600 h-2 rounded-full" style="width: ${percentage}%"></div>
                </div>
            `;
            container.appendChild(div);
        });
    }

    function renderRankStats(rankStats) {
        const container = document.getElementById('rank-stats');
        container.innerHTML = '';
        if (!rankStats || rankStats.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">Даних немає</p>';
            return;
        }
        rankStats.forEach(stat => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 border-b border-gray-100 last:border-0';
            div.innerHTML = `
                <span class="text-sm text-gray-600">${stat._id}</span>
                <span class="text-sm font-bold text-gray-900">${stat.count}</span>
            `;
            container.appendChild(div);
        });
    }

    function renderUnitStats(unitStats) {
        const container = document.getElementById('unit-stats');
        container.innerHTML = '';
        if (!unitStats || unitStats.length === 0) {
            container.innerHTML = '<p class="text-gray-500 text-sm">Даних немає</p>';
            return;
        }
        unitStats.forEach(stat => {
            const div = document.createElement('div');
            div.className = 'flex justify-between items-center py-2 border-b border-gray-100 last:border-0';
            div.innerHTML = `
                <span class="text-sm text-gray-600">${stat._id}</span>
                <span class="text-sm font-bold text-gray-900">${stat.count}</span>
            `;
            container.appendChild(div);
        });
    }

    function renderRecentAdditions(recentPersonnel) {
        const list = document.getElementById('recent-additions-list');
        list.innerHTML = '';
        if (!recentPersonnel || recentPersonnel.length === 0) {
            list.innerHTML = '<li class="py-3 text-sm text-gray-500">Немає записів.</li>';
            return;
        }
        recentPersonnel.forEach(person => {
            const li = document.createElement('li');
            li.className = 'py-3 flex items-center justify-between border-b border-gray-100 last:border-0';
            const date = new Date(person.createdAt).toLocaleDateString('uk-UA');
            li.innerHTML = `
                <div>
                    <p class="text-sm font-bold text-gray-900">${person.lastName} ${person.firstName}</p>
                    <p class="text-xs text-gray-500">${person.rank}</p>
                </div>
                <span class="text-xs text-gray-400">${date}</span>
            `;
            list.appendChild(li);
        });
    }
    
    async function loadStatistics() {
        try {
            const res = await fetchProtected(`${API_BASE}/personnel/statistics?unit=${currentUnit}`);
            const json = await res.json();
            if(json.success) {
                const data = json.data;
                document.getElementById('total-count').innerText = data.total;
                document.getElementById('active-count').innerText = data.active;
                document.getElementById('inactive-count').innerText = data.inactive;
                document.getElementById('leave-count').innerText = data.onLeave;
                
                renderStatusChart(data);
                renderBloodTypeStats(data.bloodTypeStats);
                renderRankStats(data.rankStats);
                renderUnitStats(data.unitStats);
                renderRecentAdditions(data.recentAdditions);
            }
        } catch(e) { console.error(e); }
    }
</script>
</body>
</html>